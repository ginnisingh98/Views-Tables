--------------------------------------------------------
--  DDL for Procedure XXAH_PDRT_CONTACT_DR
--------------------------------------------------------
set define off;

  CREATE OR REPLACE EDITIONABLE PROCEDURE "APPS"."XXAH_PDRT_CONTACT_DR" (errbuf    OUT VARCHAR2,
                                                       retcode   OUT NUMBER)
AS
   drc_ids             EBS_DRT_REMOVAL_REC := EBS_DRT_REMOVAL_REC ();

   i                   NUMBER;

   CURSOR C_Contact_Dir
   IS
          SELECT DISTINCT hpc.party_id person_id,
                  asu.vendor_id,
                  asu.segment1 Supp_Num,
                  asu.vendor_name,
                  hpc.party_name Contact_Name,
                  hpr.email_address,
                  hr.end_date
    FROM hz_relationships hr,
         ap_suppliers asu,
         ap_supplier_sites_all assa,
         ap_supplier_contacts asco,
         hz_org_contacts hoc,
         hz_parties hpc,
         hz_parties hpr,
         hz_contact_points hpcp
   WHERE     hoc.party_relationship_id = hr.relationship_id
         AND hr.subject_id = asu.party_id
         AND hr.relationship_code = 'CONTACT'
         AND hr.object_table_name = 'HZ_PARTIES'
         AND asu.vendor_id = assa.vendor_id
         AND hr.object_id = hpc.party_id
         AND hr.party_id = hpr.party_id
         AND asco.relationship_id = hoc.party_relationship_id
         AND assa.party_site_id = asco.org_party_site_id
         AND hpr.party_type = 'PARTY_RELATIONSHIP'
         AND hpr.party_id = hpcp.owner_table_id
         AND hpcp.owner_table_name = 'HZ_PARTIES'
         AND hpc.party_id in ('2438560','2434379','2437833','2431515','2432552','2431349','2434030','2430882','2433105','2430666','2428788','2435296','2430730','2428396','2430333','2427572','2426490','2425877','2430503','2424009','2423938','2425688','2431450','2431724','2427502','2427691','2424057','2427118','2424080','2415218','2411254','2410164','2410166','2410233','2398491','2397187','2422877','2424750','2393179','2431230','2434358','2386591','2422821','2379501','2419230','2423141','2423145','2424919','2424298','2433903','2402342','2402344','2437789','2423139','2431310','2432843','2422974','2386499','2423317','2404167','2423780','2386405','2418245','2435717','2432176','2422366','2425308','2398483','2426566','2423249','2423668','2439781','2422204','2392163','2392165','2379163','2256165','2386331','2424960','2408192','2382163','2399235','2411234','2388451','2388453','2388455','2388457','2388459','2388461','2388463','2388421','2388427','2434179','2399241','2381439','2381443','2398517','2418341','2386584','2386586','2398301','2281207','2390246','2379385','2379387','2429268','2355165','2405199','2386401','2380217','2433977','2423523','2436731','2430537','2347202','2429298','2381437','2386333','2325211','2430698','2398196','2398221','2398226','2361180','2381311','2381317','2383200','2383202','2379517','2398327','2398329','947133','2401210','2386180','2386182','2392167','2335363','2335365','2398450','2402374','2437257','2024165','2381226','2381228','2381230','2331210','2424890','2006164','2385262','2398574','2398576','2411169','2427737','2429280','2434848','2435691','2388243','2411165','2428921','2397298','2397300','2338324','2338326','2375318','2344223','2344225','2344227','2344231','2344235','2344237','2281159','2281161','2346302','2375310','2375312','2322303','2352272','2388253','2399181','2402362','2423812','2424523','2388415','2281165','2281173','2375304','2427120','2310161','2428631','2431555','2431695','2432205','2381410','2379666','2379668','2386250','2327179','2433422','2386421','2379307','2430750','2407188','2407190','2414243','2385190','2385192','2385194','2300157','2433232','2433649','2428509','2428511','2388531','2388533','2388535','2388537','2388543','2388545','2388547','2388549','2428336','2398399','2407203','2425141','2346173','2398493','2330204','2410178','2423381','2437849','2422833','2422835','2424822','2375296','2375330','2281185','2281189','2281191','2341190','2409196','2433063','2327175','2394228','2397221','2417242','2429278','2382264','2365172','2397306','2422243','2425124','2327185','2322185','2398271','2398499','2398501','2398503','2423375','2402249','2409247','2379684','1954161','2417240','2436644','2322211','2425113','2438634','2413204','2422837','2386238','2422761','2381293','2349707','2300171','2346283','2380221','2380223','2426325','2433386','2331250','2426149','2350233','2066157','2397217','2436880','2398264','2326161','2326163','2433875','2346202','2346204','2398309','2398311','2431189','2432837','2416237','2381303','2300165','2375334','2300183','2405252','2404159','2379327','2425149','2398216','2423482','2398293','2430963','1946202','2346200','2327196','2375338','2432024','2394167','2356276','2356282','2356284','2423005','2423742','2402220','2402222','2422639','2344269','2281199','2281201','2281203','2379340','2401216','2425236','2381416','2397333','2397335','2397339','2322177','2381194','2424801','2341194','2341196','2349750','2424147','2425384','2398254','1938184','2418313','2424067','2435366','2435368','2386465','2386467','2386469','2325209','2425268','2433975','1903164','2399269','2428629','2424135','2345242','2346188','2387176','1872167','2423752','2433723','2340205','1853142','2399177','2438026','2380193','2410225','1789135','2386531','2400187','1453137','1449230','2335219','2389163','2388233','2428285','1440139','2407205','2409241','2420181','2408224','2408226','2408232','2379547','2379549','2379551','2409272','2409276','1347133','1347135','2398531','2398534','2398537','2415280','2422547','2409309','2416178','2388431','2439783','2300185','2335216','2320196','2320198','2319332','2432902','2376262','2405250','2352315','2356268','2386581','2388441','2388443','2388449','2388557','2423525','2430809','2381400','1253204','1394133','2398169','2398584','2417175','2418217','2433342','2379652','2379654','2438150','2398415','2346177','2398495','1256145','2408165','2388525','2388371','2388373','2388375','2438170','1356133','2397195','2416167','2431406','2428033','2428035','1758133','1261439','2398317','2398319','2398343','2439948','1242135','2386475','1220135','1193136','2390267','1130256','2375326','2431775','1119135','1109133','1081135','2398287','2399159','2399161','2399163','1044135','1035135','984135','2398562','2410235','2422552','771135','766133','1277149','700133','2422249','680133','676135','647133','1277143','1886141','2431482','2380253','1250137','568135','2423007','2423009','546153','522136','522138','1414135','2404161','496136','546133','572133','1363142','1460135','1877145','2424131','1077133','2423369','2440143','2381552','2344185','2344187','2344189','2344212','1448158','1415163','2388513','2338161','1130252','1284138','2345238','2345240','2422871','2424555','2428245','2432995','2434191','1131146','2398419','2398421','438135','427135','2388465','2433885','413159','432134','2408220','2422561','2379169','2379171','374135','2411340','354143','343135','2386190','2398441','2409233','2409235','333142','1253283','1254491','2405197','2423810','2382195','324135','1450157','320135','2413160','2402197','298144','2381321','287135','2346190','285136','643133','1456146','1525133','284148','284139','889140','2339157','2386395','274137','1451160','2381287','2379623','1870170','255136','2386361','2386363','2386365','240135','234135','234149','265141','2426768','2281211','2281213','2281215','2425455','2425469','222139','2038158','2338238','2433678','2386511','2340215','2405241','2397207','2430890','209159','2382181','2405258','2422494','2327165','2422474','2424631','208145','2405270','206138','2300161','2300163','2306168','2345160','2345162','2437021','202135','198151','350133','196135','2386541','1582133','2423423','2426052','2428412','2328166','1902141','2388471','166135','162140','1579133','1881143','183163','656133','2409254','2418250','160144','2341200','157176','2324247','157168','2379688','145148','2424418','137145','137151','137137','302133','2432192','2322217','2334159','2398509','2421180','2421182','2324236','2424428','2425091','2401214','134075','259133','2319330','137119','941134','2398437','2398439','2431862','2344207','111075','107086','107075','98134','1653135','98110','157170','262133','411133','98081','97129','97131','148133','97090','640133','882133','1253429','2347229','2353188','2422498','2423231','2433137','2436588','94074','2380191','88082','2398315','2338301','2422500','2424995','81077','76073','2439604','69081','2381566','71075','1176136','68159','1253367','68115','137083','65106','198147','2426897','2425414','63074','61081','56233','499133','56201','145140','56143','2322285','56130','56121','1250163','56112','56104','179133','179135','56100','2398281','2408161','2431224','2383184','53097','1872155','2375298','2375328','50076','2386425','47077','2300193','2353177','2428350','433133','2397294','2425523','2349796','2433575','68093','68095','439135','1237133','1616133','1881157','1156133','2380183','2424260','377133','1435145','7120','2398339','26075','7095','7090','4050')
         --               AND asu.vendor_id = '1479211'
         AND TRUNC (hr.end_date) < (SYSDATE - 90)
         AND NOT EXISTS
                (SELECT *
                   FROM per_drt_person_data_removals a
                  WHERE a.person_id = hpc.party_id AND a.status = 'Removed')
ORDER BY asu.vendor_id DESC;

   V_entity_type       per_drt_person_data_removals.entity_type%TYPE;
   V_person_id         per_drt_person_data_removals.person_id%TYPE;
   V_full_name         per_drt_person_data_removals.full_name%TYPE;
   V_status            per_drt_person_data_removals.status%TYPE;
   V_constraint_type   per_drt_person_constraints.constraint_type%TYPE;
   V_MESSAGE_TEXT      fnd_new_messages.MESSAGE_TEXT%TYPE;
   V_last_run_id       per_drt_person_data_removals.last_run_id%TYPE;
BEGIN
   i := 1;

   FOR V_Contact_Dir IN C_Contact_Dir
   LOOP
      drc_ids.EXTEND ();
      --DBMS_OUTPUT.put_line (V_Contact_Dir.person_id);
      drc_ids (i) := ebs_drt_removal_rec_type (V_Contact_Dir.person_id, 'TCA');
      i := i + 1;
   END LOOP;

   ebs_drt_utils.entity_check_constraints (drc_ids);
   ebs_drt_utils.entity_remove (drc_ids);


   FOR V_Contact_Dir IN C_Contact_Dir
   LOOP
      BEGIN
         SELECT rem.entity_type,
                rem.person_id,
                rem.full_name,
                rem.status,
                drt.constraint_type,
                fnd.MESSAGE_TEXT,
                rem.last_run_id
           INTO V_entity_type,
                V_person_id,
                V_full_name,
                V_status,
                V_constraint_type,
                V_MESSAGE_TEXT,
                V_last_run_id
           FROM per_drt_person_data_removals rem,
                per_drt_person_constraints drt,
                fnd_new_messages fnd
          WHERE     rem.removal_id = drt.removal_id
                AND drt.msg_application_id = fnd.application_id
                AND drt.message_name = fnd.message_name
                AND language_code = USERENV ('LANG')
                AND drt.entity_type = 'TCA'
                AND rem.person_id = V_Contact_Dir.person_id;


         FND_FILE.PUT_LINE (
            FND_FILE.LOG,
               'Entity Type ==>'
            || ' '
            || V_entity_type
            || ' '
            || 'Person ID ==>'
            || ' '
            || V_person_id
            || ' '
            || 'Full Name ==>'
            || ' '
            || V_full_name
            || ' '
            || 'Error Msg ==>'
            || ' '
            || V_MESSAGE_TEXT);
      EXCEPTION
         WHEN NO_DATA_FOUND
         THEN
            FND_FILE.PUT_LINE (
               FND_FILE.LOG,
               V_Contact_Dir.person_id || ' Successfully Removed');
         WHEN OTHERS
         THEN
            FND_FILE.PUT_LINE (
               FND_FILE.LOG,
               'Error ==>' || V_Contact_Dir.person_id || SQLERRM);
      END;
   END LOOP;
END;

/
