--------------------------------------------------------
--  DDL for Package Body XTR_XTRLTDAP_XMLP_PKG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "APPS"."XTR_XTRLTDAP_XMLP_PKG" AS
/* $Header: XTRLTDAPB.pls 120.2 2007/12/31 07:18:51 npannamp noship $ */
  FUNCTION CF_SET_PARAFORMULA RETURN VARCHAR2 IS
  BEGIN
    SELECT
      SUBSTR(USER
            ,1
            ,10)
    INTO
      CP_PARA
    FROM
      DUAL;
    RETURN (CP_PARA);
  END CF_SET_PARAFORMULA;

  FUNCTION BEFOREREPORT RETURN BOOLEAN IS
    L_DMMY_NUM NUMBER;
    L_MESSAGE FND_NEW_MESSAGES.MESSAGE_TEXT%TYPE;
    CURSOR GET_LANGUAGE_DESC IS
      SELECT
        ITEM_NAME,
        SUBSTR(TEXT
              ,1
              ,100) LANG_NAME
      FROM
        XTR_SYS_LANGUAGES_VL
      WHERE MODULE_NAME = 'XTRLTDAP';
    L_NUM NUMBER;
  BEGIN
      P_CONC_REQUEST_ID := FND_GLOBAL.CONC_REQUEST_ID;

    BEGIN
      COMPANY_NAME_HEADER := CEP_STANDARD.GET_WINDOW_SESSION_TITLE;
    EXCEPTION
      WHEN OTHERS THEN
        FND_MESSAGE.SET_NAME('XTR'
                            ,'XTR_LOOKUP_ERR');
        L_MESSAGE := FND_MESSAGE.GET;
        RAISE_APPLICATION_ERROR(-20101
                               ,NULL);
    END;
    IF (P_DISPLAY_DEBUG = 'Y') THEN
      NULL;
    END IF;
    UPDATE
      XTR_SETTLEMENT_SCRIPTS_V
    SET
      LAST_RUN_ON = TO_DATE(PERIOD_FROM_DATE
             ,'DD/MM/YYYY')
      ,RUN_REQUESTED_ON = NULL
      ,ONLY_NEW_TRANSACTIONS = NULL
    --  ,LAST_FILE_CREATED = DESNAME
    WHERE SCRIPT_NAME in ( 'EFT' , 'SN' , 'SS' , 'SS2' )
      AND SCRIPT_TYPE = 'REPORT';


    UPDATE
      XTR_DEAL_DATE_AMOUNTS_V   a
    SET
      A.SETTLEMENT_ACTIONED = 'Y'
     -- ,A.SETTLEMENT_ACTIONED_FILE = DESNAME
    WHERE A.ACTUAL_SETTLEMENT_DATE = TO_DATE(PERIOD_FROM_DATE
           ,'DD/MM/YYYY')
      AND A.CASHFLOW_AMOUNT <> 0
      AND A.ACCOUNT_NO like NVL(UPPER(ACCOUNT_NUMBER)
       ,'%')
      AND A.COMPANY_CODE like NVL(UPPER(COMP_CODE)
       ,'%')
      AND A.TRANS_MTS = 'Y'
      AND A.SETTLE = 'Y'
      AND A.CHQ_REQD is NULL
      AND A.DIRECT_DEBIT is NULL
      AND ( ( UPPER(PREV_ACTIONED) = 'Y' )
    OR ( UPPER(PREV_ACTIONED) = 'N'
      AND A.SETTLEMENT_ACTIONED is NULL ) )
      AND A.ACCOUNT_NO IN (
      SELECT
        B.ACCOUNT_NUMBER
      FROM
        XTR_BANK_ACCOUNTS_V B,
        XTR_SETTLEMENT_SCRIPTS_V S
      WHERE B.ACCOUNT_NUMBER = A.ACCOUNT_NO
        AND B.ACCOUNT_NUMBER like NVL(UPPER(ACCOUNT_NUMBER)
         ,'%')
        AND B.PARTY_CODE like NVL(UPPER(COMP_CODE)
         ,'%')
        AND B.EFT_SCRIPT_NAME in ( 'EFT' , 'SN' , 'SS' , 'SS2' )
        AND S.SCRIPT_NAME = B.EFT_SCRIPT_NAME
        AND NVL(S.CURRENCY_CODE
         ,B.CURRENCY) = B.CURRENCY
        AND S.SCRIPT_TYPE = 'REPORT' );
    COMMIT;
    FOR c IN GET_LANGUAGE_DESC LOOP
      IF C.ITEM_NAME = 'Z2ACCOUNT_DETAILS_METHOD' THEN
        Z2ACCOUNT_DETAILS_METHOD := C.LANG_NAME;
      ELSIF C.ITEM_NAME = 'Z1PARAMETERS' THEN
        Z1PARAMETERS := C.LANG_NAME;
      ELSIF C.ITEM_NAME = 'REPORT_DATE' THEN
        REPORT_DATE := C.LANG_NAME;
      ELSIF C.ITEM_NAME = 'Z1COMPANY_CODE' THEN
        Z1COMPANY_CODE := C.LANG_NAME;
      ELSIF C.ITEM_NAME = 'Z1CPARTY_CODE' THEN
        Z1CPARTY_CODE := C.LANG_NAME;
      ELSIF C.ITEM_NAME = 'Z1CCY_CODE' THEN
        Z1CCY_CODE := C.LANG_NAME;
      ELSIF C.ITEM_NAME = 'Z1PERIOD_FROM_DATE' THEN
        Z1PERIOD_FROM_DATE := C.LANG_NAME;
      ELSIF C.ITEM_NAME = 'Z2PAGE' THEN
        Z2PAGE := C.LANG_NAME;
      ELSIF C.ITEM_NAME = 'Z2AMOUNT' THEN
        Z2AMOUNT := C.LANG_NAME;
      ELSIF C.ITEM_NAME = 'Z2CCY' THEN
        Z2CCY := C.LANG_NAME;
      ELSIF C.ITEM_NAME = 'Z2SETTLEMENT_DATE' THEN
        Z2SETTLEMENT_DATE := C.LANG_NAME;
      ELSIF C.ITEM_NAME = 'Z2WE_CONFIRM' THEN
        Z2WE_CONFIRM := C.LANG_NAME;
      END IF;
    END LOOP;
    RETURN (TRUE);
  END BEFOREREPORT;

  FUNCTION AFTERREPORT RETURN BOOLEAN IS
  BEGIN
    RETURN (TRUE);
  END AFTERREPORT;

  FUNCTION AFTERPFORM RETURN BOOLEAN IS
    CURSOR PROGRAM_NAME IS
      SELECT
        USER_CONCURRENT_PROGRAM_NAME
      FROM
        FND_CONCURRENT_PROGRAMS_VL
      WHERE CONCURRENT_PROGRAM_NAME = 'XTRLTDAP'
        AND APPLICATION_ID = 185;
  BEGIN
    OPEN PROGRAM_NAME;
    FETCH PROGRAM_NAME
     INTO
       REPORT_SHORT_NAME2;
    CLOSE PROGRAM_NAME;

    P_PERIOD_FROM := TO_CHAR(TO_DATE(P_PERIOD_FROM
                                    ,'YYYY/MM/DD HH24:MI:SS')
                            ,'DD-MON-YYYY');
    COMPANY_CODE2 := P_COMPANY;
    CPARTY_CODE2 := P_CPARTY;
    CCY_CODE2 := P_CURRENCY;
    PERIOD_FROM_DATE2 := P_PERIOD_FROM;
    RETURN (TRUE);
  EXCEPTION
    WHEN NO_DATA_FOUND THEN
      REPORT_SHORT_NAME2 := 'Admin-Daily Settlement LettersXX';
      RETURN (TRUE);
  END AFTERPFORM;

  FUNCTION BEFOREPFORM RETURN BOOLEAN IS
  BEGIN
    RETURN (TRUE);
  END BEFOREPFORM;

  FUNCTION BETWEENPAGE RETURN BOOLEAN IS
  BEGIN
    RETURN (TRUE);
  END BETWEENPAGE;

  FUNCTION CP_PARA_P RETURN VARCHAR2 IS
  BEGIN
    RETURN CP_PARA;
  END CP_PARA_P;

END XTR_XTRLTDAP_XMLP_PKG;


/
