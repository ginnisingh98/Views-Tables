--------------------------------------------------------
--  DDL for Package Body OKE_APPROVAL_STEPS_PKG
--------------------------------------------------------

  CREATE OR REPLACE EDITIONABLE PACKAGE BODY "APPS"."OKE_APPROVAL_STEPS_PKG" AS
/* $Header: OKEAPVEB.pls 120.1 2005/06/02 12:03:51 appldev  $ */

PROCEDURE INSERT_ROW
( X_ROWID                  IN OUT NOCOPY /* file.sql.39 change */ VARCHAR2
, X_APPROVAL_PATH_ID       IN     NUMBER
, X_APPROVAL_SEQUENCE      IN     NUMBER
, X_APPROVER_ROLE_ID       IN     NUMBER
, X_REQUIRED_FLAG          IN     VARCHAR2
, X_CREATION_DATE          IN     DATE
, X_CREATED_BY             IN     NUMBER
, X_LAST_UPDATE_DATE       IN     DATE
, X_LAST_UPDATED_BY        IN     NUMBER
, X_LAST_UPDATE_LOGIN      IN     NUMBER
, X_RECORD_VERSION_NUMBER  IN OUT NOCOPY /* file.sql.39 change */ NUMBER
) IS

CURSOR c IS
  SELECT ROWID
  FROM OKE_APPROVAL_STEPS
  WHERE APPROVAL_PATH_ID = X_APPROVAL_PATH_ID
  AND   APPROVAL_SEQUENCE = X_APPROVAL_SEQUENCE;

BEGIN

  X_RECORD_VERSION_NUMBER := 1;

  INSERT INTO OKE_APPROVAL_STEPS
  ( APPROVAL_PATH_ID
  , APPROVAL_SEQUENCE
  , APPROVER_ROLE_ID
  , REQUIRED_FLAG
  , RECORD_VERSION_NUMBER
  , CREATION_DATE
  , CREATED_BY
  , LAST_UPDATE_DATE
  , LAST_UPDATED_BY
  , LAST_UPDATE_LOGIN
  ) VALUES
  ( X_APPROVAL_PATH_ID
  , X_APPROVAL_SEQUENCE
  , X_APPROVER_ROLE_ID
  , X_REQUIRED_FLAG
  , X_RECORD_VERSION_NUMBER
  , X_CREATION_DATE
  , X_CREATED_BY
  , X_LAST_UPDATE_DATE
  , X_LAST_UPDATED_BY
  , X_LAST_UPDATE_LOGIN
  );

  OPEN c;
  FETCH c INTO X_ROWID;
  IF (c%notfound) THEN
    CLOSE c;
    RAISE NO_DATA_FOUND;
  END IF;
  CLOSE c;

END INSERT_ROW;

PROCEDURE LOCK_ROW
( X_APPROVAL_PATH_ID       IN     NUMBER
, X_APPROVAL_SEQUENCE      IN     NUMBER
, X_RECORD_VERSION_NUMBER  IN     NUMBER
) IS

CURSOR c IS
  SELECT RECORD_VERSION_NUMBER
  FROM OKE_APPROVAL_STEPS
  WHERE APPROVAL_PATH_ID = X_APPROVAL_PATH_ID
  AND APPROVAL_SEQUENCE = X_APPROVAL_SEQUENCE
  FOR UPDATE OF APPROVAL_PATH_ID NOWAIT;
RecInfo c%rowtype;

BEGIN
  OPEN c;
  FETCH c INTO RecInfo;
  IF (c%notfound) THEN
    CLOSE c;
    FND_MESSAGE.SET_NAME('FND', 'FORM_RECORD_DELETED');
    APP_EXCEPTION.RAISE_EXCEPTION;
  END IF;
  CLOSE c;
  IF (RecInfo.RECORD_VERSION_NUMBER = X_RECORD_VERSION_NUMBER) THEN
    NULL;
  ELSE
    FND_MESSAGE.SET_NAME('FND', 'FORM_RECORD_CHANGED');
    APP_EXCEPTION.RAISE_EXCEPTION;
  END IF;

  RETURN;

END LOCK_ROW;

PROCEDURE UPDATE_ROW
( X_APPROVAL_PATH_ID       IN     NUMBER
, X_APPROVAL_SEQUENCE      IN     NUMBER
, X_APPROVER_ROLE_ID       IN     NUMBER
, X_REQUIRED_FLAG          IN     VARCHAR2
, X_LAST_UPDATE_DATE       IN     DATE
, X_LAST_UPDATED_BY        IN     NUMBER
, X_LAST_UPDATE_LOGIN      IN     NUMBER
, X_RECORD_VERSION_NUMBER  IN OUT NOCOPY /* file.sql.39 change */ NUMBER
) IS

CURSOR c IS
  SELECT RECORD_VERSION_NUMBER
  FROM OKE_APPROVAL_STEPS
  WHERE APPROVAL_PATH_ID = X_APPROVAL_PATH_ID
  AND   APPROVAL_SEQUENCE = X_APPROVAL_SEQUENCE;

BEGIN
  UPDATE OKE_APPROVAL_STEPS
  SET APPROVER_ROLE_ID      = X_APPROVER_ROLE_ID
  ,   REQUIRED_FLAG         = X_REQUIRED_FLAG
  ,   LAST_UPDATE_DATE      = X_LAST_UPDATE_DATE
  ,   LAST_UPDATED_BY       = X_LAST_UPDATED_BY
  ,   LAST_UPDATE_LOGIN     = X_LAST_UPDATE_LOGIN
  ,   RECORD_VERSION_NUMBER = RECORD_VERSION_NUMBER + 1
  WHERE APPROVAL_PATH_ID = X_APPROVAL_PATH_ID
  AND APPROVAL_SEQUENCE = X_APPROVAL_SEQUENCE;

  IF (sql%notfound) THEN
    RAISE NO_DATA_FOUND;
  END IF;

END UPDATE_ROW;

PROCEDURE DELETE_ROW
( X_APPROVAL_PATH_ID       IN     NUMBER
, X_APPROVAL_SEQUENCE      IN     NUMBER
) IS
BEGIN

  DELETE FROM OKE_APPROVAL_STEPS
  WHERE APPROVAL_PATH_ID = X_APPROVAL_PATH_ID
  AND APPROVAL_SEQUENCE = X_APPROVAL_SEQUENCE;

  IF (sql%notfound) THEN
    RAISE NO_DATA_FOUND;
  END IF;

END DELETE_ROW;

PROCEDURE LOAD_ROW
( X_APPROVAL_PATH_ID       IN     NUMBER
, X_APPROVAL_SEQUENCE      IN     NUMBER
, X_APPROVER_ROLE_ID       IN     NUMBER
, X_REQUIRED_FLAG          IN     VARCHAR2
, X_LAST_UPDATE_DATE       IN     DATE
, X_LAST_UPDATED_BY        IN     NUMBER
) IS
BEGIN

  INSERT INTO OKE_APPROVAL_STEPS
  ( APPROVAL_PATH_ID
  , APPROVAL_SEQUENCE
  , APPROVER_ROLE_ID
  , REQUIRED_FLAG
  , RECORD_VERSION_NUMBER
  , CREATION_DATE
  , CREATED_BY
  , LAST_UPDATE_DATE
  , LAST_UPDATED_BY
  , LAST_UPDATE_LOGIN
  )
  SELECT X_APPROVAL_PATH_ID
  ,      X_APPROVAL_SEQUENCE
  ,      X_APPROVER_ROLE_ID
  ,      X_REQUIRED_FLAG
  ,      1
  ,      X_LAST_UPDATE_DATE
  ,      X_LAST_UPDATED_BY
  ,      X_LAST_UPDATE_DATE
  ,      X_LAST_UPDATED_BY
  ,      NULL
  FROM DUAL
  WHERE NOT EXISTS (
    SELECT NULL
    FROM   OKE_APPROVAL_STEPS
    WHERE  APPROVAL_PATH_ID = X_APPROVAL_PATH_ID
    AND (  APPROVAL_SEQUENCE = X_APPROVAL_SEQUENCE
        OR APPROVER_ROLE_ID = X_APPROVER_ROLE_ID )
  );

END LOAD_ROW;

END OKE_APPROVAL_STEPS_PKG;

/
